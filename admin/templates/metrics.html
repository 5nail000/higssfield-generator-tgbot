{% extends "base.html" %}

{% block title %}–ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –º–æ–¥–µ–ª—è–º{% endblock %}

{% block content %}
<div class="container">
    <h1>üìä –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ –º–æ–¥–µ–ª—è–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h1>
    
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filters" style="margin-bottom: 20px;">
        <form method="GET" action="{{ url_for('admin.metrics') }}" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <label>
                –ü–µ—Ä–∏–æ–¥:
                <select name="period" onchange="this.form.submit()">
                    <option value="all" {% if period == 'all' %}selected{% endif %}>–í—Å–µ –≤—Ä–µ–º—è</option>
                    <option value="day" {% if period == 'day' %}selected{% endif %}>–î–µ–Ω—å</option>
                    <option value="week" {% if period == 'week' %}selected{% endif %}>–ù–µ–¥–µ–ª—è</option>
                    <option value="month" {% if period == 'month' %}selected{% endif %}>–ú–µ—Å—è—Ü</option>
                    <option value="quarter" {% if period == 'quarter' %}selected{% endif %}>–ö–≤–∞—Ä—Ç–∞–ª</option>
                </select>
            </label>
            
            <label>
                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
                <select name="user_id" onchange="this.form.submit()">
                    <option value="">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</option>
                    {% for user in all_users %}
                    <option value="{{ user.id }}" {% if user_id == user.id %}selected{% endif %}>
                        {{ user.username or user.telegram_id }} (ID: {{ user.id }})
                    </option>
                    {% endfor %}
                </select>
            </label>
            
            <a href="{{ url_for('admin.metrics') }}" class="btn btn-secondary">–°–±—Ä–æ—Å–∏—Ç—å</a>
        </form>
    </div>
    
    <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <h3 style="margin: 0 0 10px 0; color: #6c757d; font-size: 14px;">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</h3>
            <p style="margin: 0; font-size: 32px; font-weight: bold; color: #212529;">{{ stats.total_requests }}</p>
        </div>
        
        <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <h3 style="margin: 0 0 10px 0; color: #6c757d; font-size: 14px;">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (USD)</h3>
            <p style="margin: 0; font-size: 32px; font-weight: bold; color: #28a745;">${{ "%.2f"|format(stats.total_cost_usd) }}</p>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–æ–¥–µ–ª—è–º -->
    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–æ–¥–µ–ª—è–º</h2>
    <div class="model-stats">
        {% if stats.by_model %}
        <table class="table" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="padding: 12px; text-align: left;">–ú–æ–¥–µ–ª—å</th>
                    <th style="padding: 12px; text-align: right;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤</th>
                    <th style="padding: 12px; text-align: right;">–°—Ç–æ–∏–º–æ—Å—Ç—å (USD)</th>
                    <th style="padding: 12px; text-align: right;">–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</th>
                    <th style="padding: 12px; text-align: right;">% –æ—Ç –æ–±—â–µ–≥–æ</th>
                </tr>
            </thead>
            <tbody>
                {% for model_name, model_stats in stats.by_model.items() %}
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 12px;">
                        <strong>{{ model_display_names.get(model_name, model_name) }}</strong>
                    </td>
                    <td style="padding: 12px; text-align: right;">{{ model_stats.count }}</td>
                    <td style="padding: 12px; text-align: right; color: #28a745; font-weight: bold;">
                        ${{ "%.2f"|format(model_stats.cost_usd) }}
                    </td>
                    <td style="padding: 12px; text-align: right;">
                        {% if model_stats.count > 0 %}
                        ${{ "%.2f"|format(model_stats.cost_usd / model_stats.count) }}
                        {% else %}
                        $0.00
                        {% endif %}
                    </td>
                    <td style="padding: 12px; text-align: right;">
                        {% if stats.total_cost_usd > 0 %}
                        {{ "%.1f"|format((model_stats.cost_usd / stats.total_cost_usd) * 100) }}%
                        {% else %}
                        0%
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #6c757d; margin-top: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>
        {% endif %}
    </div>
    
    <!-- –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (–ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π) -->
    {% if stats.by_model and stats.total_cost_usd > 0 %}
    <div class="chart" style="margin-top: 30px;">
        <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –º–æ–¥–µ–ª—è–º</h3>
        {% for model_name, model_stats in stats.by_model.items() %}
        <div style="margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="min-width: 150px;">{{ model_display_names.get(model_name, model_name) }}:</span>
                <div style="flex: 1; background: #e9ecef; height: 20px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #007bff; height: 100%; width: {{ ((model_stats.cost_usd / stats.total_cost_usd) * 100)|round(1) }}%;"></div>
                </div>
                <span style="min-width: 80px; text-align: right;">{{ "%.1f"|format((model_stats.cost_usd / stats.total_cost_usd) * 100) }}%</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <div style="margin-top: 30px;">
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-primary">‚Üê –ù–∞–∑–∞–¥ –∫ –¥–∞—à–±–æ—Ä–¥—É</a>
    </div>
</div>
{% endblock %}
