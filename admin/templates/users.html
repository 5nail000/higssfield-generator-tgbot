{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏{% endblock %}

{% block content %}
<h1>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>

<div class="card">
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Telegram ID</th>
                <th>–ò–º—è</th>
                <th>–ö—Ä–µ–¥–∏—Ç—ã</th>
                <th>–°–æ–∑–¥–∞–Ω</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.telegram_id }}</td>
                <td>{{ user.username or 'N/A' }}</td>
                <td>{{ "%.2f"|format(user.credits) }}</td>
                <td>{{ user.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                <td>
                    <a href="{{ url_for('admin.send_message', user_id=user.id) }}" class="btn btn-primary" style="margin-bottom: 5px;">üì® –°–æ–æ–±—â–µ–Ω–∏–µ</a>
                    <button onclick="showCreditModal({{ user.id }}, 'add')" class="btn btn-success">+ –ö—Ä–µ–¥–∏—Ç—ã</button>
                    <button onclick="showCreditModal({{ user.id }}, 'subtract')" class="btn btn-danger">- –ö—Ä–µ–¥–∏—Ç—ã</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if total_pages > 1 %}
    <div class="pagination">
        {% for p in range(1, total_pages + 1) %}
        <a href="{{ url_for('admin.users', page=p) }}" {% if p == page %}class="active"{% endif %}>{{ p }}</a>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è/—Å–ø–∏—Å–∞–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤ -->
<div id="creditModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; min-width: 300px;">
        <h2 id="modalTitle">–ù–∞—á–∏—Å–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã</h2>
        <form id="creditForm" method="POST">
            <div class="form-group">
                <label for="amount">–°—É–º–º–∞:</label>
                <input type="number" id="amount" name="amount" step="0.01" min="0.01" required>
            </div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="submit" class="btn" id="submitBtn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button type="button" onclick="closeCreditModal()" class="btn btn-danger">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
        <div id="creditMessage"></div>
    </div>
</div>

<script>
let currentUserId = null;
let currentAction = null;

function showCreditModal(userId, action) {
    currentUserId = userId;
    currentAction = action;
    const modal = document.getElementById('creditModal');
    const title = document.getElementById('modalTitle');
    const form = document.getElementById('creditForm');
    const submitBtn = document.getElementById('submitBtn');
    
    if (action === 'add') {
        title.textContent = '–ù–∞—á–∏—Å–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã';
        submitBtn.textContent = '–ù–∞—á–∏—Å–ª–∏—Ç—å';
        submitBtn.className = 'btn btn-success';
    } else {
        title.textContent = '–°–ø–∏—Å–∞—Ç—å –∫—Ä–µ–¥–∏—Ç—ã';
        submitBtn.textContent = '–°–ø–∏—Å–∞—Ç—å';
        submitBtn.className = 'btn btn-danger';
    }
    
    form.action = action === 'add' 
        ? `/users/${userId}/add_credits`
        : `/users/${userId}/subtract_credits`;
    
    modal.style.display = 'block';
}

function closeCreditModal() {
    document.getElementById('creditModal').style.display = 'none';
    document.getElementById('creditForm').reset();
    document.getElementById('creditMessage').innerHTML = '';
}

document.getElementById('creditForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const response = await fetch(this.action, {
        method: 'POST',
        body: formData
    });
    
    const result = await response.json();
    const messageDiv = document.getElementById('creditMessage');
    
    if (result.success) {
        messageDiv.innerHTML = '<div class="success">–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!</div>';
        setTimeout(() => {
            location.reload();
        }, 1000);
    } else {
        messageDiv.innerHTML = `<div class="error">${result.error || '–û—à–∏–±–∫–∞'}</div>`;
    }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.getElementById('creditModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeCreditModal();
    }
});
</script>
{% endblock %}
