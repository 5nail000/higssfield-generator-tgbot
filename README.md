# HiggsField AI Telegram Bot

## 📌 Назначение проекта

Telegram-бот для генерации изображений через платформу [Higgsfield AI](https://platform.higgsfield.ai). Проект предоставляет удобный интерфейс для работы с различными моделями генерации изображений (NanoBanana, Seedream 4.5) через Telegram, систему управления кредитами и административную панель для мониторинга активности пользователей.

## 🧠 Архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                    Telegram Bot (python-telegram-bot)        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Handlers   │  │  Keyboards   │  │   States     │      │
│  │  (1067 LOC) │  │  (UI Logic)  │  │  (FSM)       │      │
│  └──────┬──────┘  └──────┬───────┘  └──────┬───────┘      │
└─────────┼─────────────────┼─────────────────┼──────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────┐
│                    Business Logic Layer                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Database   │  │    Storage   │  │  API Client  │      │
│  │   Manager    │  │   Manager    │  │   (REST)     │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
└─────────┼─────────────────┼─────────────────┼──────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
┌─────────────────────────────────────────────────────────────┐
│                    Data & External Services                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   SQLite     │  │  File System │  │  Higgsfield   │      │
│  │   Database   │  │  (Storage)   │  │  AI Platform  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│              Flask Admin Panel (Web Interface)             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Routes     │  │    Auth      │  │  Templates   │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
└─────────┼─────────────────┼─────────────────┼──────────────┘
          │                 │                 │
          ▼                 ▼                 ▼
          └─────────────────┴─────────────────┘
                            │
                            ▼
                    Database Manager
```

### Основные компоненты:

1. **Telegram Bot** (`bot/`) - Основной интерфейс взаимодействия с пользователями
2. **API Client** (`api/`) - Интеграция с Higgsfield AI Platform
3. **Database Manager** (`database/`) - Управление данными пользователей и истории
4. **File Manager** (`storage/`) - Управление файлами пользователей
5. **Admin Panel** (`admin/`) - Веб-интерфейс для администраторов
6. **Configuration** (`config/`) - Централизованная конфигурация

## 📁 Структура каталогов

```
203-HiggsField/
├── admin/                    # Flask админ-панель
│   ├── app.py               # Создание Flask приложения
│   ├── auth.py              # Авторизация администраторов
│   ├── routes.py            # Маршруты админки
│   └── templates/           # HTML шаблоны
├── api/                     # API клиенты
│   └── client.py            # Клиенты для NanoBanana и Seedream
├── bot/                     # Telegram бот
│   ├── bot.py              # Основной класс бота
│   ├── handlers.py          # Обработчики команд и сообщений
│   ├── keyboards.py         # Клавиатуры для бота
│   └── states.py            # Состояния пользователей
├── config/                  # Конфигурация
│   ├── settings.py         # Загрузка настроек из config.json
│   └── constants.py        # Константы приложения
├── database/               # База данных
│   ├── models.py           # SQLAlchemy модели
│   ├── db_manager.py       # Менеджер БД
│   └── app.db             # SQLite база данных
├── storage/                # Файловое хранилище
│   ├── file_manager.py     # Менеджер файлов
│   └── users/              # Файлы пользователей
│       └── {user_id}/
│           ├── last_uploads/  # Последние загруженные фото
│           ├── results/       # Сгенерированные изображения
│           └── used/          # Использованные файлы
├── tests/                  # Тесты
├── utils/                  # Утилиты
│   └── logger.py          # Настройка логирования
├── logs/                   # Логи приложения
├── config.json            # Конфигурационный файл
├── requirements.txt       # Зависимости Python
└── run.py                # Точка входа приложения
```

## 🚀 Как запустить

### Предварительные требования

- Python 3.8+
- Доступ к интернету для работы с Telegram Bot API и Higgsfield AI Platform
- Публичный IP-адрес или домен для доступа к файлам пользователей (опционально)
- Оплаченный баланс на cloud.higgsfield.ai

### Установка

1. **Клонируйте репозиторий** (или используйте существующий проект)

2. **Установите зависимости:**
```bash
pip install -r requirements.txt
```

3. **Настройте конфигурацию:**
   - Скопируйте `config.json.example` в `config.json` и заполните необходимые параметры:
   ```json
   {
     "telegram_bot_token": "YOUR_BOT_TOKEN",
     "telegram_bot_admin_id": YOUR_ADMIN_TELEGRAM_ID,
     "higgsfield_api_key": "YOUR_API_KEY",
     "higgsfield_api_key_secret": "YOUR_API_SECRET",
     "higgsfield_api_url": "https://cloud.higgsfield.ai/api",
     "admin_password": "YOUR_ADMIN_PASSWORD",
     "storage_path": "storage/users",
     "database_path": "database/app.db",
     "flask_host": "0.0.0.0",
     "flask_port": 5000,
     "log_level": "INFO",
     "log_file": "logs/app.log",
     "max_file_size": 10485760,
     "api_generation_timeout": 300
   }
   ```

4. **Запустите приложение:**
```bash
python run.py
```

Приложение запустит:
- Telegram бота в основном потоке
- Flask админ-панель в отдельном потоке (доступна на `http://localhost:5000`)

## ⚙️ Конфигурация

### Основные параметры `config.json`:

| Параметр | Описание | Обязательный |
|----------|----------|--------------|
| `telegram_bot_token` | Токен Telegram бота от @BotFather | ✅ |
| `telegram_bot_admin_id` | Telegram ID администратора | ✅ |
| `higgsfield_api_key` | API ключ Higgsfield | ✅ |
| `higgsfield_api_key_secret` | Секретный ключ API | ✅ |
| `admin_password` | Пароль для админ-панели | ✅ |
| `api_generation_timeout` | Таймаут генерации в секундах (по умолчанию 300) | ❌ |
| `max_file_size` | Максимальный размер файла в байтах (по умолчанию 10MB) | ❌ |

### Константы приложения (`config/constants.py`):

- `GENERATION_CREDIT_COST = 50.0` - Стоимость одной генерации
- `INITIAL_USER_CREDITS = 10000.0` - Начальный баланс новых пользователей
- `CREDIT_REQUEST_AMOUNT = 2500.0` - Сумма запроса на пополнение
- `MAX_PHOTOS_NANOBANANA = 8` - Максимум фото для NanoBanana
- `MAX_PHOTOS_SEEDREAM = 14` - Максимум фото для Seedream

## 📊 Логика работы (Pipeline)

### Процесс генерации изображения:

```
1. Пользователь отправляет промпт
   ↓
2. Бот проверяет баланс кредитов (требуется 50 кредитов)
   ↓
3. Бот предлагает загрузить референсные фото (опционально)
   ↓
4. Пользователь загружает фото или пропускает шаг
   ↓
5. Бот предлагает выбрать соотношение сторон (4:3, 16:9, 1:1, 9:16, 3:4, 21:9)
   ↓
6. Бот отправляет запрос в Higgsfield AI API
   ↓
7. API возвращает task_id (задача поставлена в очередь)
   ↓
8. Бот периодически опрашивает статус задачи (polling каждые 5 секунд)
   ↓
9. Когда статус = "completed", бот получает URL изображения
   ↓
10. Бот скачивает изображение и сохраняет локально
   ↓
11. Бот отправляет изображение пользователю (как файл + как фото)
   ↓
12. Бот списывает кредиты и записывает действие в историю
```

### Управление файлами:

- **Временные файлы** (загруженные пользователем) → `storage/users/{user_id}/last_uploads/`
- **Результаты генерации** → `storage/users/{user_id}/results/`
- **Использованные файлы** → `storage/users/{user_id}/used/` (при очистке `last_uploads`)

### Система кредитов:

- Новые пользователи получают **10000 кредитов** при регистрации
- Каждая генерация стоит **50 кредитов**
- Пользователь может запросить пополнение на **2500 кредитов** (требует одобрения администратора)
- Администратор может начислить неограниченное количество кредитов через веб-панель

## 🧪 Тестирование

### Запуск тестов:

```bash
# Все тесты
pytest tests/

# Конкретный тест
pytest tests/test_api.py

# С подробным выводом
pytest -v tests/
```

### Структура тестов:

- `test_api.py` - Тестирование API клиентов
- `test_api_generation.py` - Тестирование процесса генерации
- `test_file_upload.py` - Тестирование загрузки файлов

## 🧩 Расширение проекта

### Добавление нового режима генерации:

1. **Добавьте константы** в `config/constants.py`:
   ```python
   MODE_NEW_MODE = "new_mode"
   MODE_NAME_NEW_MODE = "🎨 New Mode"
   MAX_PHOTOS_NEW_MODE = 10
   ```

2. **Создайте API клиент** в `api/client.py`:
   ```python
   class NewModeAPIClient:
       # Реализуйте методы generate(), get_request_status(), wait_for_completion()
   ```

3. **Обновите `get_api_client()`** для поддержки нового режима

4. **Добавьте режим в клавиатуру** в `bot/keyboards.py`

5. **Обновите обработчики** в `bot/handlers.py` для поддержки нового режима

### Добавление новых команд бота:

1. Создайте функцию-обработчик в `bot/handlers.py`
2. Зарегистрируйте обработчик в `bot/bot.py` в методе `_setup_handlers()`

### Добавление новых маршрутов админки:

1. Создайте функцию-обработчик в `admin/routes.py`
2. Используйте декоратор `@admin_bp.route()` для регистрации маршрута

## ❗ Известные ограничения

1. **SQLite база данных** - Не подходит для высоконагруженных систем. Для продакшена рекомендуется PostgreSQL или MySQL.

2. **Локальное хранилище файлов** - Файлы хранятся на локальном диске. Для масштабирования рекомендуется использовать S3 или аналогичные решения.

3. **Синхронный polling** - Ожидание завершения генерации блокирует поток. Для больших нагрузок рекомендуется асинхронная обработка через очереди (Redis, RabbitMQ).

4. **Простая авторизация админки** - Используется простое сравнение паролей. Для продакшена рекомендуется хеширование (bcrypt, argon2).

5. **Один экземпляр бота** - Бот не поддерживает горизонтальное масштабирование. Для масштабирования требуется архитектура с очередями и воркерами.

## 🛣 Roadmap (идеи развития)

### Краткосрочные улучшения:

- [ ] Добавление поддержки batch-генерации (несколько изображений за раз)
- [ ] Кэширование результатов генерации
- [ ] Улучшение обработки ошибок с retry-логикой
- [ ] Добавление метрик и мониторинга

### Среднесрочные улучшения:

- [ ] Миграция на PostgreSQL
- [ ] Интеграция с S3 для хранения файлов
- [ ] Асинхронная обработка через Redis/RabbitMQ
- [ ] Добавление вебхуков для уведомлений о завершении генерации

### Долгосрочные улучшения:

- [ ] Поддержка нескольких языков интерфейса
- [ ] Система шаблонов промптов
- [ ] Интеграция с другими AI-платформами
- [ ] Мобильное приложение

## 📝 Лицензия

[Укажите лицензию проекта]

## 👥 Авторы

[Укажите авторов проекта]

## 📞 Контакты

[Укажите контактную информацию]
